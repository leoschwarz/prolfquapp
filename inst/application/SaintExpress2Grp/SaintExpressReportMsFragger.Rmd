---
title: "AP-MS vignette"
author: "Functional Genomics Center Zurich"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
  bookdown::html_document2:
    toc: true
  pdf_document: 
    toc: true
params:
  sep: NULL
    
---

```{r setup, include=FALSE}
library(ggraph)
library(igraph)
library(prolfqua)

SEP <- params$sep
sp_string <- if (SEP$spc) {"spectral counts"} else {"intensities"}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

BFABRIC <- SEP$BFABRIC
```


# Bfabric

The inputs are available in b-fabric workunit: [`r BFABRIC$inputID`](`r BFABRIC$inputURL`). The bfabric dataset `r BFABRIC$datasetID` was used to annotate the samples.

The outputs are available in b-fabric workunit: [`r BFABRIC$workunitID`](`r BFABRIC$workunitURL`), in project ID `r BFABRIC$projectID` with order ID `r BFABRIC$orderID`.

# Introduction


Data was preprocessed using the _Fragpipe_ application (version V16). The protein quantification results were extracted from the _combined_protein.tsv_ file.  We used the columns with the `r if(SEP$spc){'Spectral Count' }else{'Intensity'}` suffix, which stores the `r if(SEP$spc){'total number of PSMs in support of the protein identification'} else {'normalized protein intensity using the sequences after razor assignment'}`. For more information about the _combined_protein.tsv_ file see [fragpipe output tutorial]( https://fragpipe.nesvilab.org/docs/tutorial_fragpipe_outputs.html#combined_proteintsv).

# Sample QC

In total `r SEP$lfqdata$hierarchy_counts()[2]` proteins with at least 2 peptides per protein were quantified using `r sp_string`. 

```{r sampleAnnotation}
DT::datatable(SEP$lfqdata$factors(),
              caption = "Sample annotation table.")
```

(ref:violinPlot) Violin plot showing the distribution of $\log_2$ transformed `r sp_string` for all samples.

```{r violinPlot, fig.cap="(ref:violinPlot)", fig.with=10, fig.height=7}
pl <- SEP$lfqdata$get_Plotter()
pl$intensity_distribution_violin()
```

(ref:missingpercond) Nr. of proteins with 0, 1, 2, etc. missing values

```{r missingpercond, fig.cap="(ref:missingpercond)", fig.with=10, fig.height=7, include = FALSE}
sum <- SEP$lfqdata$get_Summariser()
sum$plot_missingness_per_condition()

```

(ref:nrPerSample) Barplot showing the number of proteins (y-axis) reported in each sample (x-axis).

```{r nrPerSample, fig.cap="(ref:nrPerSample)", fig.with=10, fig.height=7}
sum$plot_hierarchy_counts_sample()

```


```{r heatmap}
hm <- SEP$lfqdata$get_Plotter()$raster()

```

(ref:raster) Heatmap of $\log_2$ transformed `r sp_string`. (NO clustering).

```{r raster, fig.cap="(ref:raster)", fig.width=7, fig.height=7}
hm
hm <- SEP$lfqdata$get_Plotter()$heatmap()
```


(ref:heatmapProt) Heatmap (rows - proteins, columns - samples) showing the row scaled $\log_2$ transformed `r sp_string` with clustering (hierarchical complete linkage, euclidean distance) of samples and proteins.

```{r heatmapProt, fig.cap="(ref:heatmapProt)", fig.width=7, fig.height=7}
hm
hm <- pl$NA_heatmap()

```

(ref:naHeat) Heatmap (rows - proteins, columns - samples) showing missing values. White - protein is observed, Black - protein is unobserved.

```{r naHeat, fig.cap="(ref:naHeat)" , fig.width=7, fig.height=7}
plot.new()
hm
```

(ref:pca) Plot of first and second principal component (PC1 and PC2) of principal component analysis (PCA). $\log_2$ transformed `r sp_string` are used as imput.

```{r pca, fig.cap = "(ref:pca)" , fig.width=7, fig.height=7 }
SEP$lfqdata$get_Plotter()$pca_plotly()
```



# Saint analysis


To analyse the data we used the [SaintExpress software](http://saint-apms.sourceforge.net/Main.html).

Protein interactions will be filtered with an _SaintScore_ of `r SEP$SSthreshold` and a fold change threshold of `r SEP$FCthreshold` which corresponds to a $\log_2(`r SEP$FCthreshold`)$ of `r log2(SEP$FCthreshold)`.



```{r include = FALSE}
dd <- SEP$cse$get_contrasts() |> select(Bait, BFDR)
dd <- dd |> mutate(FDRrange =  cut(BFDR , breaks = c( -0.01, 0.05, 0.1, 0.25, 1)) )
xt <- dd |> group_by(Bait, FDRrange) |> summarize(n = n()) |> na.omit()
lv <- levels(xt$FDRrange)
xt <- xt |> pivot_wider(id_cols = "Bait", names_from = "FDRrange", values_from = n)
xt[,c("Bait",lv)] |> knitr::kable(caption = "# of interactions reported with FDR < 0.05; < 0.1; < 0.25; < 1.")

```

```{r}
dd <- SEP$cse$get_contrasts() |> select(Bait, SaintScore)

dd <- dd |> mutate(SaintScorerange =  cut(SaintScore , breaks = c(-0.01, SEP$SSthreshold, 1)))
xt <- dd |> group_by(Bait, SaintScorerange) |> summarize(n = n()) |> na.omit()

lv <- levels(xt$SaintScorerange)
xt <- xt |> pivot_wider(id_cols = "Bait", names_from = "SaintScorerange", values_from = n)
xt[is.na(xt)] <- 0

xt <- xt[,c("Bait",rev(lv))]
colnames(xt)[2:3] <- c("accpeted","rejected")
xt |>  knitr::kable( caption =
                 paste0("# of interactions accepted with SaintScore ", SEP$SSthreshold,".")
                 )
               
```


(ref:scatterplot) Scatter plot showing SaintScore (y-axis) vs. $\log_2(FC)$ (x-axis). Red horizontal line _SaintScore_ of `r SEP$SSthreshold`. Red vertical line $\log_2(FC)$ of `r log2(SEP$FCthreshold)`.

```{r scatterplot, fig.cap = "(ref:scatterplot)", fig.width=7, fig.height=7}
SEP$pcse$score_plotly()[[1]]
```


```{r fig.cap = "Volcano Plot log2FC vs BFDR.", fig.width=7, fig.height=7, include = FALSE, eval = FALSE}
SEP$pcse$volcano_plotly()[[1]]
```

(ref:maplot) MA Plot - x-axis mean protein intensity, y-axis $\log_2(FC)$. Red horizontal line $\log_2(FC)$  = `r log2(SEP$FCthreshold)`.

```{r maplot, fig.cap = "(ref:maplot)", fig.width=7, fig.height=7}
SEP$pcse$ma_plotly()
```

(ref:network) Protein interaction network for _SaintScore_ > `r SEP$SSthreshold` and foldchange > `r SEP$FCthreshold`. Lines - protein interactions. Line color depends on the Bait proteins.

```{r network, fig.cap="(ref:network)"}
bbSE <- select(SEP$sig, from = Bait, to = Prey, 
             Bait = Bait, SS = SaintScore)

inn <- igraph::graph_from_data_frame( bbSE, directed = FALSE )

library(ggraph)
ggraph(inn,layout = 'kk') +
  geom_node_text(aes(label = name), size = 2.5) +
  geom_edge_link(aes(color = Bait), alpha = 0.6) + 
  theme(legend.position = "none")

```


(ref:vennDiagram) Venn diagram showing the number of interaction partners common and distinct for various baits, for _SaintScore_ > `r SEP$SSthreshold`.


```{r vennDiagram, fig.cap="(ref:vennDiagram)"}
b1 <- bbSE |> select(from, to)
xx <-  split(b1$to, b1$from)
ggVennDiagram::ggVennDiagram(xx)

```


```{r}
sigsub <- SEP$lfqdata$get_subset(data.frame(protein_Id = SEP$sig$Prey))
rs <- sigsub$get_Plotter()$raster(rownames = TRUE)

```

(ref:heatsig) Heatmap showing the $\log_2$ transformed `r sp_string` of proteins with _SaintScore_ > `r SEP$SSthreshold`.

```{r, fig.cap="(ref:heatsig)", fig.width=8, fig.height=10}
rs
```


```{r DT}
cap <- paste0("Proteins with SaintScore > ", SEP$SSthreshold, " and foldchange > ", SEP$FCthreshold, ".")
DT::datatable(SEP$sig, caption = cap)
```

# Supplment

```{r fig.cap="x axis - Saint Score, y axis = -log10(BFDR)"}

ggplot( SEP$cse$get_contrasts(), aes(x = SaintScore, y = -log10(BFDR) ) ) +
  geom_point() +
  geom_vline(xintercept = SEP$SSthreshold, color = 'red') +
  facet_wrap( ~ Bait )

```

# Session Info

```{r}
pander::pander(sessionInfo())
```

# References
