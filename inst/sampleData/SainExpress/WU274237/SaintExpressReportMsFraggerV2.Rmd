---
title: "Interaction Proteomics Report"
author: "Functional Genomics Center Zurich"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
  bookdown::html_document2:
    toc: true
  pdf_document: 
    toc: true
params:
  sep: NULL
  FCt: 4
  SCt: 0.95 
---

```{r setup, include=FALSE}
library(DT)
library(ggraph)
library(igraph)
library(prolfqua)
library(tidyverse)
SEP <- params$sep
sp_string <- if (SEP$spc) {"spectral counts"} else {"intensities"}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

BFABRIC <- SEP$BFABRIC
```


# B-fabric related information

*Projekt ID: `r BFABRIC$projectID`
*Order ID: `r BFABRIC$orderID`

The input data, used to compile this report, is available through the b-fabric resource: [`r BFABRIC$inputID`](`r BFABRIC$inputURL`). The b-fabric dataset `r BFABRIC$datasetID` was used to annotate the LC-MS files. The complete output, including this report, R code used for analysis and intermediate results, is available through the b-fabric workunit: [`r BFABRIC$workunitID`](`r BFABRIC$workunitURL`).

# Introduction

- General introduction into interaction proteomics analysis
- Terminology: bait, prey
- AP-MS, Proximity labeling

# Results

- Overview of results
- Aim
- How to use the results

## Peptide and Protein identification

The LC-MS data was processed using the [FragPipe proteomics pipeline](https://fragpipe.nesvilab.org/). The protein quantification results were extracted from the _combined_protein.tsv_ file.  We used the columns with the `r if(SEP$spc){'Spectral Count' }else{'Intensity'}` suffix, which stores the `r if(SEP$spc){'total number of PSMs in support of the protein identification'} else {'normalized protein intensity using the sequences after razor assignment'}`. For more information about the _combined_protein.tsv_ file see [FragPipe output tutorial]( https://fragpipe.nesvilab.org/docs/tutorial_fragpipe_outputs.html#combined_proteintsv).

The table below lists the LC-MS files and their assigned annotations.

```{r sampleAnnotation}
DT::datatable(SEP$lfqdata$factors(),
              caption = "LC-MS raw file annotation table. The content of the sampleName column is used as a short form plot label and constructed from the CorT and bait attributes. CorT indicates if a raw file was assigned to the control group (C) or to the treatment group (T). The bait protein name is shown in the bait column. It should follow the <name>_<condition> pattern.")
```

In total `r SEP$lfqdata$hierarchy_counts()[2]` proteins (min. 2 peptides per protein) were identidied and quantified using `r sp_string` across all samples (we will denote this as the protein abundance estimate from here on). Bar plot below shows the number of identified proteins per raw file.

```{r nrPerSample, fig.cap="Number of identified proteins across raw files.", fig.with=10, fig.height=7}
sum <- SEP$lfqdata$get_Summariser()
sum$plot_hierarchy_counts_sample()

```

### Protein abundance analysis

The violin plot (Figure \@ref(fig:violinPlot)) displays the protein abundance distribution for all raw files of the data set. Mayor differences between raw files could be a hint that the individual protein abundance values are affected by technical biases. These biases might need to be corrected, in order to separate them from biological effects.

(ref:violinPlot) Protein abundance distribution. The dots represent the median log2-transformed abundance value per raw file.
The overall density distribution is shown as a rotated kernel density plot.


```{r violinPlot, fig.cap="(ref:violinPlot)", fig.with=10, fig.height=7}
pl <- SEP$lfqdata$get_Plotter()
pl$intensity_distribution_violin()
```

### Missing value analysis

The analysis of missing values can also be an important indicator for potential problems and biases in the data. We therefore visualize the structure of missing values (missing protein abundance estimate per protein) using different plots. Figure \@ref(fig:missingpercond) displays how many proteins show 0, 1, or 3 missing values within their replication group.

(ref:missingpercond) Missing value statistic across raw files and bait constructs. 

```{r missingpercond, fig.cap="(ref:missingpercond)", fig.with=10, fig.height=7, include = TRUE}
sum <- SEP$lfqdata$get_Summariser()
sum$plot_missingness_per_group()

```


```{r createraster, echo=FALSE, include=FALSE}
hm <- SEP$lfqdata$get_Plotter()$raster()
```

The following protein abundance heatmap highlights missing values using grey cells.


(ref:raster) Heatmap of log2-transformed protein abundance. Proteins are shown in rows, raw files are shown in columns. The figure key indicates which bait groups a raw files belongs to.
```{r raster, echo=FALSE, fig.cap="(ref:raster)", fig.width=7, fig.height=7}
hm
hm <- SEP$lfqdata$get_Plotter()$heatmap()
```


```{r NAheatmap, echo=FALSE, include=TRUE, fig.cap="Protein abundance heatmap (rows indicate proteins, columns indicate raw files) showing the row scaled log2 transformed protein abundance value. Co-clustering (hierarchical complete linkage, euclidean distance) of samples and proteins was used.", fig.width=7, fig.height=7}
hm
hm <- pl$NA_heatmap()
```

By transforming protein abundance estimates into present/absent calls a dichotomous view on the data can be constructed.

```{r WhatIsThisDoing, echo=FALSE, fig.cap="Protein abundance heatmap (rows indicate proteins, columns indicate raw files) showing missing protein abundance estimates across data set. White: Protein is observed, black: Protein is not observed.", fig.width=7, fig.height=7}
plot.new()
hm
```

### Principal component analysis

```{r pca, fig.cap = "Plot of first and second principal component (PC1 and PC2) of principal component analysis (PCA). log2-transformed protein abundance is used as input." , fig.width=7, fig.height=7 }
SEP$lfqdata$get_Plotter()$pca_plotly()
```


## Interaction scoring using SAINT

In order to score potential interactions between observed proteins (potential prays) and the bait protein we used the [SaintExpress software](http://saint-apms.sourceforge.net/Main.html). The plots below show one subpanel for each bait present in the data set. All resulting candidate lists are filtered using an _SaintScore_ threshold of `r SEP$SSthreshold` and a fold-change threshold of `r SEP$FCthreshold` which corresponds to a $\log_2(`r SEP$FCthreshold`)$ of `r log2(SEP$FCthreshold)`.

```{r chunkName, include = FALSE}
dd <- SEP$cse$get_contrasts() %>% select(Bait, BFDR)
dd <- dd %>% mutate(FDRrange =  cut(BFDR , breaks = c( -0.01, 0.05, 0.1, 0.25, 1)) )
xt <- dd %>% group_by(Bait, FDRrange) %>% summarize(n = n()) %>% na.omit()
lv <- levels(xt$FDRrange)
xt <- xt %>% pivot_wider(id_cols = "Bait", names_from = "FDRrange", values_from = n)
xt[,c("Bait",lv)] %>% knitr::kable(caption = "# of interactions reported with FDR < 0.05; < 0.1; < 0.25; < 1.")

```

```{r someChunkName, include=FALSE}
dd <- SEP$cse$get_contrasts() %>% select(Bait, SaintScore)

dd <- dd %>% mutate(SaintScorerange =  cut(SaintScore , breaks = c(-0.01, SEP$SSthreshold, 1)))
xt <- dd %>% group_by(Bait, SaintScorerange) %>% summarize(n = n()) %>% na.omit()

lv <- levels(xt$SaintScorerange)
xt <- xt %>% pivot_wider(id_cols = "Bait", names_from = "SaintScorerange", values_from = n)
xt[is.na(xt)] <- 0

xt <- xt[,c("Bait",rev(lv))]
colnames(xt)[2:3] <- c("accpeted","rejected")
xt |>  knitr::kable( caption =
                 paste0("# of interactions accepted with SaintScore ", SEP$SSthreshold,".")
                 )
               
```

The Vulcano plot helps to identify prey proteins that show a reproducible co-enrichment with respect to a bait protein.

```{r volcanoPlot_SS, fig.cap = "Vulcano plot showing significance (SaintScore) as a function of effect size estimate (log2-transformed fold-change). Each dot represent a potential pray protein. Red horizontal line indicates significance threshhold as described above. Red vertical line indicates fold-change threshold. Promissing candiate pray proteins are found in the upper right sector of the plot.", fig.width=7, fig.height=7}
SEP$pcse$score_plotly()[[1]]
```

An alternative signifance estimate is the Bayesian FDR (BFDR). The volcano plot below uses the same data as above with the exception that the significance dimension is a transformed BFDR.

```{r volcanoPlot_bfdr, fig.cap = "Volcano Plot showing -log10-transformed BFDR as function of log2-transformed effect size estimate.", fig.width=7, fig.height=7, include = TRUE, eval = TRUE}
SEP$pcse$volcano_plotly()[[1]]
```

Sometimes measured effects sizes (differences between samples groups) are biased by the signal intensity (here protein abundance). Such systematic effects can be explored using MA-plots. 

```{r maplot, fig.cap = "MA plot displays the effect size estimate as a function of the mean protein intensity across conditions (baits). Each dot represents an observed protein. Red horizontal lines represent the fold-change threshold", fig.width=7, fig.height=7}
SEP$pcse$ma_plotly()
```


```{r aChunkNamePLEASE}
sigsub <- SEP$lfqdata$get_subset(data.frame(protein_Id = SEP$sig$Prey))
rs <- sigsub$get_Plotter()$raster(rownames = TRUE)

```

The following protein abundance heatmap is prefiltered for prays that show a sig. effect.

```{r anotherChunkNamePlease, fig.cap="Heatmap showing the log2-transformed protein abundance estimate for prays with SaintScore above the sthreshold in at least one contrast.", fig.width=8, fig.height=10}
rs
```

```{r DT}
cap <- paste0("Proteins with SaintScore > ", SEP$SSthreshold, " and foldchange > ", SEP$FCthreshold, ".")
DT::datatable(SEP$sig, caption = cap)
```

## Interaction network reconstruction

```{r network, fig.cap="Protein interaction network reconstruction using graph. Nodes represent bait proteins shown in ... and bait proteins shown in ... . Edges indicate bait-pray interactions scored above the chosen threshholds. Line color depends on the bait proteins."}
bbSE <- select(SEP$sig, from = Bait, to = Prey, 
             Bait = Bait, SS = SaintScore)

inn <- igraph::graph_from_data_frame( bbSE, directed = FALSE )

library(ggraph)
ggraph(inn,layout = 'kk') +
  geom_node_text(aes(label = name), size = 2.5) +
  geom_edge_link(aes(color = Bait), alpha = 0.6) + 
  theme(legend.position = "none")

```

```{r vennDiagram, fig.cap="Venn diagram showing the number of prays common to various bait proteins in the data set."}
b1 <- bbSE %>% select(from, to)
xx <-  split(b1$to, b1$from)
ggVennDiagram::ggVennDiagram(xx)

```


# Supplement

```{r chunkNamesAreNeeded, fig.cap="x axis - Saint Score, y axis = -log10(BFDR)"}

ggplot( SEP$cse$get_contrasts(), aes(x = SaintScore, y = -log10(BFDR) ) ) +
  geom_point() +
  geom_vline(xintercept = SEP$SSthreshold, color = 'red') +
  facet_wrap( ~ Bait )

```

# Session Info

```{r sessionInfo}
pander::pander(sessionInfo())
```

# References
