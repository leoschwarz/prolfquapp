#!/usr/bin/env bash
# This script is used to run a single command in the prolfquapp docker image.
# - The docker image is pulled if it does not exist locally.
# - The current directory will be mounted to /work and set as the current working directory for the command being executed.
set -euo pipefail

if [[ $# -eq 0 ]] || [[ $1 == "-h" ]] || [[ $1 == "--help" ]]; then
    echo "Usage: $0 <command> [--version VERSION] [args]"
    echo "Example commands: "
    echo " $0 prolfqua_yaml.sh"
    echo " $0 prolfqua_dataset.sh"
    echo " (see README.md for more details)"
    exit 1
fi


if [[ $1 == "--version" || $1 == "-v" ]]; then
  if [[ $# -lt 3 ]]; then
    echo "Error: --version requires a version number."
    exit 1
  fi
  DOCKER_IMAGE_VERSION="$2"
  shift 2
else
  DOCKER_IMAGE_VERSION=0.0.1
fi
DOCKER_IMAGE=docker.io/leoschwarz/prolfquapp:$DOCKER_IMAGE_VERSION

# Use podman if available, fallback to docker.
if command -v podman >/dev/null 2>&1; then
  DOCKER="podman"
else
  DOCKER="docker"
fi
echo "Using $DOCKER to run $DOCKER_IMAGE"


if ! $DOCKER image inspect "$DOCKER_IMAGE" >/dev/null 2>&1; then
  echo "Image $DOCKER_IMAGE not found locally. Pulling..."
  $DOCKER pull "$DOCKER_IMAGE"
else
  echo "Image $DOCKER_IMAGE already exists locally."
  echo "If you want to update the image to the latest version, run the following command:"
  echo "$DOCKER pull \"$DOCKER_IMAGE\""
fi
$DOCKER run  \
  --user="$(id -u):$(id -g)" \
  --rm -it --mount type=bind,source="$(pwd)",target=/work \
  -w /work "$DOCKER_IMAGE" "$@"
